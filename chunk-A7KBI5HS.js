import{a as X}from"./chunk-MPOD3TBQ.js";import{a as G}from"./chunk-C2AJT47N.js";import{e as H,f as S,g as z,h as R,i as j,k as B,l as Q,q as U,r as W,t as Z}from"./chunk-XVVISF6R.js";import{A as k,D as l,Ea as O,G as D,K as g,N as v,O as C,P as f,R as T,S as V,T as r,U as o,V as u,W as x,X as p,Y as h,aa as I,ba as P,ca as A,da as s,fa as F,ib as $,jb as q,qa as L,r as y,ra as N,u as m,v as c}from"./chunk-J337Y4CE.js";import{d as J,e as E}from"./chunk-FDERIQAA.js";var _=J(X());var Y=["mapContainer"],ee=(a,t)=>t.place_id;function te(a,t){a&1&&(r(0,"span",10),s(1,"Name is required"),o())}function ie(a,t){if(a&1){let e=x();r(0,"button",36),p("click",function(){let n=m(e).$implicit,d=h(2);return c(d.selectSuggestion(n))})("mouseenter",function(){let n=m(e).$index,d=h(2);return c(d.highlightedIndex.set(n))}),u(1,"lucide-icon",37),s(2),o()}if(a&2){let e=t.$implicit,i=t.$index,n=h(2);C("highlighted",i===n.highlightedIndex()),l(),v("size",14),l(),F(" ",e.display_name," ")}}function ne(a,t){if(a&1&&(r(0,"div",14),T(1,ie,3,4,"button",35,ee),o()),a&2){let e=h();l(),V(e.addressSuggestions())}}function oe(a,t){a&1&&(r(0,"span",10),s(1,"Address is required"),o())}function re(a,t){a&1&&(r(0,"span",10),s(1,"City is required"),o())}function ae(a,t){a&1&&(r(0,"span",10),s(1,"Please enter a valid email address"),o())}function se(a,t){if(a&1){let e=x();r(0,"button",38),p("click",function(){m(e);let n=h();return c(n.confirmDelete())}),u(1,"lucide-icon",39),s(2," Delete "),o()}a&2&&(l(),v("size",16))}function le(a,t){a&1&&(u(0,"span",40),s(1," Saving... "))}function de(a,t){if(a&1&&s(0),a&2){let e=h();F(" ",e.isEditMode?"Update Structure":"Create Structure"," ")}}function me(a,t){if(a&1){let e=x();r(0,"div",41),p("click",function(){m(e);let n=h();return c(n.onDeleteCancel())}),r(1,"div",42),p("click",function(n){return m(e),c(n.stopPropagation())}),r(2,"h3",43),s(3,"Delete Structure"),o(),r(4,"p",44),s(5,"Are you sure you want to delete this structure? This action cannot be undone."),o(),r(6,"div",45)(7,"button",28),p("click",function(){m(e);let n=h();return c(n.onDeleteCancel())}),s(8,"Cancel"),o(),r(9,"button",38),p("click",function(){m(e);let n=h();return c(n.onDeleteConfirm())}),s(10,"Delete"),o()()()()}}var K=class a{id;mapContainer;fb=y(U);router=y(O);facade=y(G);location=y(L);form;isSubmitting=!1;showDeleteDialog=!1;addressSuggestions=k([]);highlightedIndex=k(-1);map=null;marker=null;searchTimeout=null;get isEditMode(){return!!this.id}goBack(){this.location.back()}confirmDelete(){this.showDeleteDialog=!0}onDeleteCancel(){this.showDeleteDialog=!1}onDeleteConfirm(){this.id&&this.facade.deleteStructure(this.id).subscribe(()=>{this.router.navigate(["/structures"])}),this.showDeleteDialog=!1}ngOnInit(){this.initForm(),this.isEditMode&&this.loadStructure()}ngAfterViewInit(){setTimeout(()=>this.initMap(),100)}ngOnDestroy(){this.map&&this.map.remove(),this.searchTimeout&&clearTimeout(this.searchTimeout)}initForm(){this.form=this.fb.group({name:["",[S.required,S.minLength(2)]],address:["",S.required],city:["",S.required],description:[""],openingHours:[""],phone:[""],email:["",[S.email]],coordinates:this.fb.group({lat:[null],lng:[null]})})}initMap(){if(!this.mapContainer?.nativeElement||this.map)return;let t=41.9028,e=12.4964;this.map=_.map(this.mapContainer.nativeElement,{scrollWheelZoom:!1,dragging:!_.Browser.mobile}).setView([t,e],5),this.map.on("focus",()=>{this.map?.scrollWheelZoom.enable()}),this.map.on("mouseout",()=>{this.map?.scrollWheelZoom.disable()}),_.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"\xA9 OpenStreetMap"}).addTo(this.map),this.map.on("click",i=>{this.map?.scrollWheelZoom.enable(),this.updateMapMarker(i.latlng.lat,i.latlng.lng),this.form.patchValue({coordinates:{lat:i.latlng.lat,lng:i.latlng.lng}}),this.reverseGeocode(i.latlng.lat,i.latlng.lng)})}loadStructure(){this.facade.loadStructure(this.id);let t=setInterval(()=>{let e=this.facade.selectedStructure();e&&e.id===this.id&&(this.form.patchValue({name:e.name,address:e.address,city:e.city,description:e.description||"",openingHours:e.openingHours||"",phone:e.phone||"",email:e.email||"",coordinates:{lat:e.coordinates.lat,lng:e.coordinates.lng}}),clearInterval(t),setTimeout(()=>{this.updateMapMarker(e.coordinates.lat,e.coordinates.lng)},200))},100)}onAddressInput(t){let e=t.target.value;if(this.searchTimeout&&clearTimeout(this.searchTimeout),e.length<3){this.addressSuggestions.set([]);return}this.searchTimeout=setTimeout(()=>{this.searchAddress(e)},300)}onAddressKeydown(t){let e=this.addressSuggestions();if(t.key==="ArrowDown"){t.preventDefault();let i=Math.min(this.highlightedIndex()+1,e.length-1);this.highlightedIndex.set(i)}else if(t.key==="ArrowUp"){t.preventDefault();let i=Math.max(this.highlightedIndex()-1,0);this.highlightedIndex.set(i)}else t.key==="Enter"&&this.highlightedIndex()>=0?(t.preventDefault(),this.selectSuggestion(e[this.highlightedIndex()])):t.key==="Escape"&&this.addressSuggestions.set([])}searchAddress(t){return E(this,null,function*(){try{let i=yield(yield fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=5&addressdetails=1`)).json();this.addressSuggestions.set(i),this.highlightedIndex.set(-1)}catch(e){console.error("Address search failed:",e),this.addressSuggestions.set([])}})}selectSuggestion(t){let e=parseFloat(t.lat),i=parseFloat(t.lon),n=t.address,d="";if(n){let w=n.road||n.street||n.pedestrian||n.footway||"",M=n.house_number||"";w&&M?d=`${w} ${M}`:w?d=w:d=t.display_name.split(",")[0]}else d=t.display_name.split(",")[0];let b=n?.city||n?.town||n?.municipality||n?.village||n?.county||"";this.form.patchValue({address:d,city:b,coordinates:{lat:e,lng:i}}),this.addressSuggestions.set([]),this.updateMapMarker(e,i)}reverseGeocode(t,e){return E(this,null,function*(){try{let n=yield(yield fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${e}&addressdetails=1`)).json();n.address&&this.form.patchValue({address:n.address.road?`${n.address.road}${n.address.house_number?" "+n.address.house_number:""}`:n.display_name.split(",")[0],city:n.address.city||n.address.town||n.address.municipality||""})}catch(i){console.error("Reverse geocoding failed:",i)}})}onCoordinatesChange(){let t=this.form.get("coordinates")?.value;t?.lat&&t?.lng&&this.updateMapMarker(t.lat,t.lng)}updateMapMarker(t,e){this.map&&(this.marker?this.marker.setLatLng([t,e]):this.marker=_.marker([t,e]).addTo(this.map),this.map.setView([t,e],15))}isFieldInvalid(t){let e=this.form.get(t);return!!(e&&e.invalid&&e.touched)}isCoordinateInvalid(t){let e=this.form.get(`coordinates.${t}`);return!!(e&&e.invalid&&e.touched)}onSubmit(){if(this.form.invalid){this.form.markAllAsTouched();return}this.isSubmitting=!0;let t=this.form.value;(this.isEditMode?this.facade.updateStructure(this.id,t):this.facade.createStructure(t)).subscribe({next:i=>{let n=this.isEditMode?this.id:i.id;this.router.navigate(["/structures",n],{queryParams:{t:Date.now()}})},error:()=>{this.isSubmitting=!1}})}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=D({type:a,selectors:[["app-structure-form"]],viewQuery:function(e,i){if(e&1&&I(Y,5),e&2){let n;P(n=A())&&(i.mapContainer=n.first)}},inputs:{id:"id"},decls:61,vars:20,consts:[["mapContainer",""],[1,"page-container"],[3,"title","subtitle"],[1,"form-layout-split",3,"ngSubmit","formGroup"],[1,"form-column"],[1,"form-card"],[1,"form-section-title"],[1,"form-group"],["for","name",1,"form-label"],["type","text","id","name","formControlName","name","placeholder","Enter structure name",1,"form-input"],[1,"form-error"],["for","address",1,"form-label"],[1,"address-input-wrapper"],["type","text","id","address","formControlName","address","placeholder","Start typing an address...","autocomplete","off",1,"form-input",3,"input","keydown"],[1,"suggestions-dropdown"],["for","city",1,"form-label"],["type","text","id","city","formControlName","city","placeholder","City name",1,"form-input"],["for","description",1,"form-label"],["id","description","formControlName","description","rows","3","placeholder","Optional description of the structure",1,"form-input","form-textarea"],["for","openingHours",1,"form-label"],["type","text","id","openingHours","formControlName","openingHours","placeholder","e.g., Mon-Fri: 09:00-18:00",1,"form-input"],["for","phone",1,"form-label"],["type","tel","id","phone","formControlName","phone","placeholder","e.g., +39 02 1234567",1,"form-input"],["for","email",1,"form-label"],["type","email","id","email","formControlName","email","placeholder","e.g., info@company.com",1,"form-input"],[1,"form-actions"],["type","button",1,"btn","btn-danger"],[1,"form-actions-right"],["type","button",1,"btn","btn-outline",3,"click"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"map-column"],[1,"map-card"],[1,"map-container"],[1,"map-hint"],[1,"dialog-overlay"],["type","button",1,"suggestion-item",3,"highlighted"],["type","button",1,"suggestion-item",3,"click","mouseenter"],["name","map-pin",3,"size"],["type","button",1,"btn","btn-danger",3,"click"],["name","trash-2",3,"size"],[1,"spinner"],[1,"dialog-overlay",3,"click"],[1,"dialog-content",3,"click"],[1,"dialog-title"],[1,"dialog-message"],[1,"dialog-actions"]],template:function(e,i){if(e&1){let n=x();r(0,"div",1),u(1,"app-page-header",2),r(2,"form",3),p("ngSubmit",function(){return m(n),c(i.onSubmit())}),r(3,"div",4)(4,"div",5)(5,"h3",6),s(6,"General Information"),o(),r(7,"div",7)(8,"label",8),s(9,"Name *"),o(),u(10,"input",9),g(11,te,2,0,"span",10),o(),r(12,"div",7)(13,"label",11),s(14,"Address *"),o(),r(15,"div",12)(16,"input",13),p("input",function(b){return m(n),c(i.onAddressInput(b))})("keydown",function(b){return m(n),c(i.onAddressKeydown(b))}),o(),g(17,ne,3,0,"div",14),o(),g(18,oe,2,0,"span",10),o(),r(19,"div",7)(20,"label",15),s(21,"City *"),o(),u(22,"input",16),g(23,re,2,0,"span",10),o(),r(24,"div",7)(25,"label",17),s(26,"Description"),o(),u(27,"textarea",18),o()(),r(28,"div",5)(29,"h3",6),s(30,"Contact Details"),o(),r(31,"div",7)(32,"label",19),s(33,"Opening Hours"),o(),u(34,"input",20),o(),r(35,"div",7)(36,"label",21),s(37,"Phone"),o(),u(38,"input",22),o(),r(39,"div",7)(40,"label",23),s(41,"Email"),o(),u(42,"input",24),g(43,ae,2,0,"span",10),o()(),r(44,"div",25),g(45,se,3,1,"button",26),r(46,"div",27)(47,"button",28),p("click",function(){return m(n),c(i.goBack())}),s(48,"Cancel"),o(),r(49,"button",29),g(50,le,2,0)(51,de,1,1),o()()()(),r(52,"div",30)(53,"div",31)(54,"h3",6),s(55,"Location Preview"),o(),u(56,"div",32,0),r(58,"p",33),s(59,"Select an address to see the location on the map"),o()()()(),g(60,me,11,0,"div",34),o()}e&2&&(l(),v("title",i.isEditMode?"Edit Structure":"New Structure")("subtitle",i.isEditMode?"Update structure information":"Add a new building or location"),l(),v("formGroup",i.form),l(8),C("error",i.isFieldInvalid("name")),l(),f(i.isFieldInvalid("name")?11:-1),l(5),C("error",i.isFieldInvalid("address")),l(),f(i.addressSuggestions().length>0?17:-1),l(),f(i.isFieldInvalid("address")?18:-1),l(4),C("error",i.isFieldInvalid("city")),l(),f(i.isFieldInvalid("city")?23:-1),l(19),C("error",i.isFieldInvalid("email")),l(),f(i.isFieldInvalid("email")?43:-1),l(2),f(i.isEditMode?45:-1),l(4),v("disabled",i.form.invalid||i.isSubmitting),l(),f(i.isSubmitting?50:51),l(10),f(i.showDeleteDialog?60:-1))},dependencies:[N,W,j,H,z,R,B,Q,q,$,Z],styles:[".form-column[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:24px}.map-card[_ngcontent-%COMP%]{position:sticky;top:88px}.address-input-wrapper[_ngcontent-%COMP%]{position:relative}.suggestions-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;right:0;background:hsl(var(--card));border:1px solid hsl(var(--border));border-radius:var(--radius);box-shadow:0 10px 25px #0003;z-index:100;max-height:240px;overflow-y:auto;margin-top:4px}.suggestion-item[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:10px;width:100%;padding:12px;text-align:left;background:transparent;border:none;color:hsl(var(--foreground));font-size:13px;line-height:1.4;cursor:pointer;transition:background .1s ease}.suggestion-item[_ngcontent-%COMP%]:hover, .suggestion-item.highlighted[_ngcontent-%COMP%]{background:hsl(var(--accent))}.suggestion-item[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{flex-shrink:0;margin-top:2px;color:hsl(var(--muted-foreground))}"],changeDetection:0})};export{K as StructureFormComponent};
