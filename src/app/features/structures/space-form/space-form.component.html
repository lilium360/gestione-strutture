<div class="page-container">
    <app-page-header [title]="isEditMode ? 'Edit Space' : 'New Space'"
        [subtitle]="structureName() ? 'for ' + structureName() : ''">
    </app-page-header>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-layout-narrow">
        <div class="form-card">
            <h3 class="form-section-title">Space Information</h3>

            <div class="form-group">
                <label for="name" class="form-label">Name *</label>
                <input type="text" id="name" formControlName="name" class="form-input"
                    [class.error]="isFieldInvalid('name')" placeholder="e.g., Conference Room A">
                @if (isFieldInvalid('name')) {
                <span class="form-error">Name is required</span>
                }
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="type" class="form-label">Type *</label>
                    <select id="type" formControlName="type" class="form-input form-select"
                        [class.error]="isFieldInvalid('type')">
                        <option value="">Select a type</option>
                        @for (type of spaceTypes; track type) {
                        <option [value]="type">{{ getTypeLabel(type) }}</option>
                        }
                    </select>
                    @if (isFieldInvalid('type')) {
                    <span class="form-error">Type is required</span>
                    }
                </div>

                <div class="form-group">
                    <label for="floor" class="form-label">Floor</label>
                    <input type="number" id="floor" formControlName="floor" class="form-input" placeholder="e.g., 1">
                </div>
            </div>

            <div class="form-group">
                <label for="capacity" class="form-label">Capacity</label>
                <input type="number" id="capacity" formControlName="capacity" class="form-input" min="1"
                    placeholder="Number of people">
            </div>
        </div>

        <div class="form-card">
            <h3 class="form-section-title">Features</h3>
            <p class="form-hint-text">Select the amenities available in this space</p>

            <div class="features-grid">
                @for (feature of allFeatures(); track feature.id) {
                <label class="feature-checkbox">
                    <input type="checkbox" [checked]="isFeatureSelected(feature.id)"
                        (change)="toggleFeature(feature.id)">
                    <span class="checkbox-label">{{ feature.name }}</span>
                </label>
                }
                <!-- Add Feature Button -->
                <button type="button" class="add-feature-btn" (click)="openAddFeaturePanel()">
                    <lucide-icon name="plus" [size]="18"></lucide-icon>
                    <span>Add New</span>
                </button>
            </div>

            @if (allFeatures().length === 0) {
            <p class="no-features">No features available. Click "Add New" to create one.</p>
            }
        </div>

        <!-- Add Feature Offcanvas -->
        @if (showAddFeaturePanel()) {
        <div class="offcanvas-overlay" [class.closing]="isClosingPanel()" (click)="closeAddFeaturePanel()"></div>
        <div class="offcanvas-panel" [class.closing]="isClosingPanel()">
            <div class="offcanvas-header">
                <h3 class="offcanvas-title">Add New Feature</h3>
                <button type="button" class="offcanvas-close" (click)="closeAddFeaturePanel()">
                    <lucide-icon name="x" [size]="20"></lucide-icon>
                </button>
            </div>
            <div class="offcanvas-body">
                <form [formGroup]="featureForm" (ngSubmit)="onCreateFeature()">
                    <div class="form-group">
                        <label for="featureName" class="form-label">Name *</label>
                        <input type="text" id="featureName" formControlName="name" class="form-input"
                            [class.error]="isFeatureFieldInvalid('name')" placeholder="e.g., Wi-Fi, Projector">
                        @if (isFeatureFieldInvalid('name')) {
                        <span class="form-error">Name is required</span>
                        }
                    </div>

                    <div class="form-group">
                        <label for="featureCategory" class="form-label">Category *</label>
                        <select id="featureCategory" formControlName="category" class="form-input form-select"
                            [class.error]="isFeatureFieldInvalid('category')">
                            <option value="">Select a category</option>
                            @for (cat of featureCategories; track cat) {
                            <option [value]="cat">{{ getFeatureCategoryLabel(cat) }}</option>
                            }
                        </select>
                        @if (isFeatureFieldInvalid('category')) {
                        <span class="form-error">Category is required</span>
                        }
                    </div>

                    <div class="form-group">
                        <label for="featureIcon" class="form-label">Icon *</label>
                        <select id="featureIcon" formControlName="icon" class="form-input form-select"
                            [class.error]="isFeatureFieldInvalid('icon')">
                            <option value="">Select an icon</option>
                            @for (icon of featureIcons; track icon.value) {
                            <option [value]="icon.value">{{ icon.label }}</option>
                            }
                        </select>
                        @if (isFeatureFieldInvalid('icon')) {
                        <span class="form-error">Icon is required</span>
                        }
                    </div>

                    <div class="form-group">
                        <label for="featureDescription" class="form-label">Description</label>
                        <textarea id="featureDescription" formControlName="description" class="form-input form-textarea"
                            rows="2" placeholder="Optional description"></textarea>
                    </div>
                </form>
            </div>
            <div class="offcanvas-footer">
                <button type="button" class="btn btn-outline" (click)="closeAddFeaturePanel()">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="onCreateFeature()"
                    [disabled]="featureForm.invalid || isCreatingFeature()">
                    @if (isCreatingFeature()) {
                    <span class="spinner"></span>
                    Creating...
                    } @else {
                    Create Feature
                    }
                </button>
            </div>
        </div>
        }

        <div class="form-actions">
            @if (isEditMode) {
            <button type="button" class="btn btn-danger" (click)="confirmDelete()">
                <lucide-icon name="trash-2" [size]="16"></lucide-icon>
                Delete
            </button>
            }
            <div class="form-actions-right">
                <button type="button" class="btn btn-outline" (click)="goBack()">Cancel</button>
                <button type="submit" class="btn btn-primary" [disabled]="form.invalid || isSubmitting">
                    @if (isSubmitting) {
                    <span class="spinner"></span>
                    Saving...
                    } @else {
                    {{ isEditMode ? 'Update Space' : 'Create Space' }}
                    }
                </button>
            </div>
        </div>
    </form>

    <!-- Delete Confirmation Dialog -->
    @if (showDeleteDialog) {
    <div class="dialog-overlay" (click)="onDeleteCancel()">
        <div class="dialog-content" (click)="$event.stopPropagation()">
            <h3 class="dialog-title">Delete Space</h3>
            <p class="dialog-message">Are you sure you want to delete this space? This action cannot be undone.</p>
            <div class="dialog-actions">
                <button type="button" class="btn btn-outline" (click)="onDeleteCancel()">Cancel</button>
                <button type="button" class="btn btn-danger" (click)="onDeleteConfirm()">Delete</button>
            </div>
        </div>
    </div>
    }
</div>